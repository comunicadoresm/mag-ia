# System Architecture - MAG-IA (Magnetic.IA)

**Generated:** 2026-02-17
**Generated By:** @architect (Aria) via @aios-master (Orion)
**Workflow:** brownfield-discovery (Phase 1)
**Branch:** refactor/aios

---

## Executive Summary

MAG-IA (Magnetic.IA) is an AI-powered chat platform built for content marketing professionals. It provides multiple specialized AI agents, a content script kanban board, voice DNA analysis for personalized content, and a credit-based monetization system. The project was generated on the **Lovable** platform (formerly GPT Engineer) and uses a React + Supabase stack with Edge Functions as the backend layer.

---

## 1. Tech Stack

| Layer | Technology | Version |
|-------|-----------|---------|
| **Framework** | React | 18.3.1 |
| **Language** | TypeScript | 5.8.3 |
| **Build Tool** | Vite (SWC plugin) | 5.4.19 |
| **CSS** | Tailwind CSS | 3.4.17 |
| **UI Components** | shadcn/ui (Radix UI) | Latest |
| **Icons** | lucide-react | 0.462.0 |
| **Routing** | React Router DOM | 6.30.1 |
| **State/Data** | TanStack React Query | 5.83.0 |
| **Forms** | React Hook Form + Zod | 7.61.1 / 3.25.76 |
| **Backend** | Supabase (BaaS) | 2.93.3 |
| **Charts** | Recharts | 2.15.4 |
| **DnD** | dnd-kit | 6.3.1 |
| **Markdown** | react-markdown | 10.1.0 |
| **Carousel** | embla-carousel-react | 8.6.0 |
| **Toasts** | sonner + radix-toast | 1.7.4 |
| **Drawers** | vaul | 0.9.9 |
| **Command** | cmdk | 1.1.1 |
| **Testing** | Vitest + Testing Library | 3.2.4 |
| **Platform Origin** | Lovable (lovable-tagger) | 1.1.13 |

---

## 2. Project Structure

```
mag-ia/
├── public/                          # Static assets
├── src/
│   ├── App.tsx                      # Root component + routing
│   ├── main.tsx                     # Entry point
│   ├── components/
│   │   ├── admin/                   # Admin panel components (11 files)
│   │   │   ├── AdminAgentsSection.tsx
│   │   │   ├── AdminCreditPackages.tsx
│   │   │   ├── AdminCreditsOverview.tsx
│   │   │   ├── AdminMetricsDashboard.tsx
│   │   │   ├── AdminPlanTypes.tsx
│   │   │   ├── AdminUpsellPlans.tsx
│   │   │   ├── AdminUserCredits.tsx
│   │   │   ├── AgentDocuments.tsx
│   │   │   ├── ScriptOptionsManagement.tsx
│   │   │   ├── ScriptStructureEditor.tsx
│   │   │   ├── ScriptTemplateManagement.tsx
│   │   │   ├── SortableAgentList.tsx
│   │   │   └── UserManagement.tsx
│   │   ├── credits/                 # Credit system components (6 files)
│   │   ├── kanban/                  # Content kanban board (8 files)
│   │   ├── modals/                  # Global modals (2 files)
│   │   ├── onboarding/             # Onboarding flows (8 files)
│   │   │   ├── MagneticOnboarding.tsx
│   │   │   ├── NarrativeFlow.tsx / NarrativeSetup.tsx
│   │   │   ├── VoiceDNAFlow.tsx / VoiceDNASetup.tsx
│   │   │   ├── FormatQuizFlow.tsx / FormatQuizSetup.tsx
│   │   │   └── AudioRecorder.tsx
│   │   ├── ui/                      # shadcn/ui primitives (44+ files)
│   │   └── [22 app-level components]
│   ├── contexts/                    # React Contexts (3 files)
│   │   ├── AuthContext.tsx
│   │   ├── SidebarContext.tsx
│   │   └── CreditsModalContext.tsx
│   ├── hooks/                       # Custom hooks (9 files)
│   │   ├── use-mobile.tsx
│   │   ├── use-toast.ts
│   │   ├── useCredits.ts
│   │   ├── useCreditHistory.ts
│   │   ├── useCycleProgress.ts
│   │   ├── useDashboardMetrics.ts
│   │   ├── useHotmartCheckout.ts
│   │   ├── usePlanPermissions.ts
│   │   └── useUpsellPlans.ts
│   ├── integrations/
│   │   └── supabase/
│   │       ├── client.ts            # Supabase client setup
│   │       └── types.ts             # Auto-generated DB types
│   ├── lib/
│   │   └── utils.ts                 # Utility functions (cn, etc.)
│   ├── pages/                       # Route pages (15 files)
│   │   ├── Login.tsx / Verify.tsx / AccessDenied.tsx
│   │   ├── Home.tsx / Agents.tsx / Chat.tsx / History.tsx
│   │   ├── Profile.tsx / Credits.tsx
│   │   ├── Kanban.tsx
│   │   ├── Admin.tsx / AdminAgents.tsx / AdminCredits.tsx
│   │   ├── Index.tsx / NotFound.tsx
│   ├── test/
│   │   ├── setup.ts
│   │   └── example.test.ts
│   └── types/
│       ├── index.ts
│       ├── credits.ts
│       └── kanban.ts
├── supabase/
│   ├── config.toml
│   ├── migrations/                  # 31 SQL migrations
│   └── functions/                   # 16 Edge Functions
│       ├── admin-create-user/
│       ├── admin-delete-user/
│       ├── admin-update-email/
│       ├── chat/                    # AI chat endpoint (core)
│       ├── consume-credits/
│       ├── generate-script/         # Script generation
│       ├── generate-script-chat/    # Script chat
│       ├── hotmart-webhook/         # Payment webhook
│       ├── process-document/
│       ├── process-voice-dna/       # Voice analysis
│       ├── recalibrate-voice/
│       ├── recheck-user-plans/
│       ├── renew-credits/
│       ├── send-auth-email/
│       ├── setup-user-plan/
│       └── verify-student/
├── package.json
├── vite.config.ts
├── tailwind.config.ts
├── tsconfig.json
├── eslint.config.js
├── vitest.config.ts
└── components.json                  # shadcn/ui config
```

---

## 3. Application Architecture

### 3.1 Route Map

| Route | Page | Auth | Description |
|-------|------|------|-------------|
| `/` | Redirect → `/login` | No | Entry redirect |
| `/login` | Login | No | Magic link (OTP) auth |
| `/verify` | Verify | No | OTP verification |
| `/access-denied` | AccessDenied | No | Unauthorized access |
| `/home` | Home | Yes | Main dashboard |
| `/agents` | Agents | Yes | Agent selector |
| `/chat/:conversationId` | Chat | Yes | AI chat interface |
| `/history` | History | Yes | Conversation history |
| `/profile` | Profile | Yes | User profile |
| `/profile/credits` | Credits | Yes | Credit dashboard |
| `/kanban` | Kanban | Yes | Content script board |
| `/admin` | Admin | Yes (admin) | Admin panel |

### 3.2 Context Architecture

```
QueryClientProvider (TanStack)
  └── TooltipProvider
        └── BrowserRouter
              └── AuthProvider          ← Supabase Auth (OTP/magic link)
                    └── CreditsModalProvider  ← Global credit modals
                          └── SidebarProvider     ← Sidebar state
                                └── <AppRoutes />
```

### 3.3 Authentication Flow

1. User enters email on `/login`
2. Edge Function `verify-student` validates if email is authorized
3. `signInWithOtp()` sends magic link
4. User enters OTP on `/verify`
5. Session persisted in localStorage via Supabase Auth
6. `AuthContext` manages session state, auto-redirect

### 3.4 Data Flow Pattern

```
Component → supabase.from('table').select() → Supabase DB
Component → supabase.functions.invoke('fn') → Edge Function → AI/DB
Component → supabase.channel().on('postgres_changes') → Realtime
```

**NOTE:** There is NO service/repository layer. Components call Supabase directly.

---

## 4. Database Schema (Key Tables)

| Table | Purpose | Relationships |
|-------|---------|---------------|
| `profiles` | User profiles (extends auth.users) | PK: auth.users.id |
| `agents` | AI agent definitions (prompt, model, config) | - |
| `agent_documents` | Documents uploaded per agent | FK → agents |
| `agent_plan_access` | Which plans can use which agents | FK → agents, plan_types |
| `agent_tags` | Tags for agent categorization | FK → agents, tags |
| `conversations` | User-agent conversations | FK → profiles, agents |
| `messages` | Chat messages | FK → conversations |
| `access_logs` | User activity logs | FK → profiles |
| `credit_cost_config` | Credit costs per action | - |
| `plan_types` | Subscription plan definitions | - |
| Additional tables | Credits, purchases, scripts, onboarding, voice DNA | Various FKs |

**Migrations:** 31 SQL migration files
**RLS:** Enabled on all tables
**Views:** `agents_public` (filtered public agent view)

---

## 5. Edge Functions (Backend)

| Function | Purpose | Category |
|----------|---------|----------|
| `chat` | AI chat with agents (Claude API) | Core |
| `generate-script` | AI script generation | Content |
| `generate-script-chat` | Script editing chat | Content |
| `process-voice-dna` | Voice DNA analysis | Onboarding |
| `recalibrate-voice` | Voice recalibration | Onboarding |
| `process-document` | Document processing | Content |
| `verify-student` | Email authorization check | Auth |
| `send-auth-email` | Custom auth email | Auth |
| `consume-credits` | Credit deduction | Billing |
| `renew-credits` | Credit renewal | Billing |
| `setup-user-plan` | Plan initialization | Billing |
| `recheck-user-plans` | Plan validation | Billing |
| `hotmart-webhook` | Hotmart payment webhook | Billing |
| `admin-create-user` | Admin user creation | Admin |
| `admin-delete-user` | Admin user deletion | Admin |
| `admin-update-email` | Admin email update | Admin |

---

## 6. Feature Modules

| Module | Components | Description |
|--------|-----------|-------------|
| **Chat** | ChatBubble, ChatInput, ChatSidebar, IceBreakers | AI conversation interface with realtime |
| **Agents** | AgentCard, AgentSelector | AI agent browsing and selection |
| **Kanban** | KanbanBoard, KanbanCard, KanbanColumn, ScriptEditor, AIScriptChat | Content script management board |
| **Credits** | CreditBadge, CreditAlert, CreditCompositionChart, CycleProgressBar | Credit balance, history, analytics |
| **Admin** | AdminAgentsSection, UserManagement, AdminMetricsDashboard | Platform administration |
| **Onboarding** | MagneticOnboarding, NarrativeFlow, VoiceDNAFlow, FormatQuizFlow | Multi-step user onboarding |
| **Modals** | BuyCreditsModal, UpsellModal, UpgradePrompt, FeatureGate | Monetization and feature gating |

---

## 7. Identified Technical Debts

### CRITICAL

| ID | Debt | Impact | Area |
|----|------|--------|------|
| TD-01 | **No service/repository layer** — All components call Supabase directly (~20+ files import supabase client) | Code duplication, untestable, tightly coupled | Architecture |
| TD-02 | **TypeScript strictness disabled** — `noImplicitAny: false`, `strictNullChecks: false` | Runtime errors, poor type safety | Code Quality |
| TD-03 | **No test coverage** — Only 1 example test exists | No regression protection | Testing |

### HIGH

| ID | Debt | Impact | Area |
|----|------|--------|------|
| TD-04 | **No error boundary** — No React ErrorBoundary components | Unhandled errors crash entire app | Reliability |
| TD-05 | **No API abstraction** — Edge functions called inline with error parsing hacks | Fragile error handling, hard to maintain | Architecture |
| TD-06 | **No route guards** — Auth check is per-page via useEffect | Inconsistent protection, flash of unauthenticated content | Security |
| TD-07 | **Lovable dependency** — `lovable-tagger` in devDeps, Lovable-specific patterns | Platform lock-in | Independence |
| TD-08 | **No loading/error states standardized** — Each page implements own loading/error | Inconsistent UX | UX |

### MEDIUM

| ID | Debt | Impact | Area |
|----|------|--------|------|
| TD-09 | **No design system documentation** — Brand colors (CM) defined but not documented | Inconsistent UI development | Design |
| TD-10 | **Duplicate sidebar components** — MainSidebar, HomeSidebar, ChatSidebar, Sidebar | Code duplication, divergent behavior | Frontend |
| TD-11 | **No environment validation** — Env vars used without validation at startup | Silent failures in production | Config |
| TD-12 | **QueryClient with defaults** — No staleTime, retry, or error handler configured | Excessive refetching, no global error handling | Performance |
| TD-13 | **No code splitting** — All pages loaded eagerly via direct imports | Larger initial bundle | Performance |
| TD-14 | **Console.error scattered** — Error handling relies on console.error + toast | No centralized logging/monitoring | Observability |
| TD-15 | **No CI/CD pipeline** — No GitHub Actions or deployment automation visible | Manual deployments, no quality gates | DevOps |

### LOW

| ID | Debt | Impact | Area |
|----|------|--------|------|
| TD-16 | **Pages with mixed concerns** — Chat.tsx is 407 lines with data fetching + UI + handlers | Hard to maintain | Code Organization |
| TD-17 | **Legacy route redirects** — `/admin/agents` and `/admin/credits` still have redirect routes | Dead code | Cleanup |
| TD-18 | **No Prettier config** — Only ESLint, no consistent formatting | Style inconsistency | DX |

---

## 8. Configuration & Environment

### Environment Variables

```
VITE_SUPABASE_URL          # Supabase project URL
VITE_SUPABASE_PUBLISHABLE_KEY  # Supabase anon key
```

Additional env vars likely used in Edge Functions (Anthropic API key, Hotmart secrets, etc.)

### Build Configuration

- **Dev server:** port 8080, HMR overlay disabled
- **Path alias:** `@/` → `./src/`
- **Plugin:** lovable-tagger (dev only)
- **Dark mode:** class-based (Tailwind `darkMode: ["class"]`)
- **Font:** Inter (sans-serif)

### Brand Tokens (Tailwind)

- `cm-yellow`, `cm-yellow-hover` — Primary brand color
- `cm-cream` — Light background
- `cm-gray-dark`, `cm-gray-darker`, `cm-gray-card` — Dark tones
- `bubble-user`, `bubble-assistant` — Chat bubble colors
- Custom shadows: `shadow-cm`, `shadow-glow`
- Custom animations: fade-in, slide-up, slide-in-right, shimmer

---

## 9. Summary Metrics

| Metric | Value |
|--------|-------|
| **Total .tsx/.ts files** | ~130+ |
| **Pages** | 15 |
| **App Components** | ~55 (excluding ui/) |
| **UI Primitives (shadcn)** | 44+ |
| **Custom Hooks** | 9 |
| **Contexts** | 3 |
| **Edge Functions** | 16 |
| **DB Migrations** | 31 |
| **Test Files** | 1 (example only) |
| **Primary Language** | TypeScript (100%) |
| **Platform Origin** | Lovable |

---

## 10. Architecture Diagram

```
┌──────────────────────────────────────────────────┐
│                   FRONTEND                        │
│  React 18 + Vite + Tailwind + shadcn/ui          │
│                                                   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│  │  Pages  │ │Components│ │ Hooks   │            │
│  │ (15)    │ │ (~100)   │ │ (9)     │            │
│  └────┬────┘ └────┬────┘ └────┬────┘            │
│       │           │           │                   │
│  ┌────┴───────────┴───────────┴────┐             │
│  │      Supabase Client (direct)    │  ← NO      │
│  │      supabase.from().select()    │    SERVICE  │
│  │      supabase.functions.invoke() │    LAYER    │
│  │      supabase.channel().on()     │             │
│  └──────────────┬──────────────────┘             │
└─────────────────┼────────────────────────────────┘
                  │
                  ▼
┌──────────────────────────────────────────────────┐
│                  SUPABASE                         │
│                                                   │
│  ┌─────────────┐  ┌──────────────┐               │
│  │   Auth       │  │  Realtime    │               │
│  │  (OTP/Magic) │  │  (postgres_  │               │
│  │              │  │   changes)   │               │
│  └──────────────┘  └──────────────┘               │
│                                                   │
│  ┌─────────────┐  ┌──────────────┐               │
│  │  Database    │  │ Edge Functions│               │
│  │  (PostgreSQL)│  │ (16 functions)│               │
│  │  31 tables   │  │              │               │
│  │  RLS enabled │  │ chat → Claude│               │
│  └──────────────┘  │ billing →    │               │
│                    │   Hotmart    │               │
│  ┌─────────────┐  │ voice → AI   │               │
│  │  Storage     │  └──────────────┘               │
│  │  (documents) │                                 │
│  └──────────────┘                                 │
└──────────────────────────────────────────────────┘
```

---

*Generated by @architect (Aria) via brownfield-discovery workflow*
*— Aria, arquitetando o futuro*
